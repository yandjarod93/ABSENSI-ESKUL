<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABSEN DIGITAL ESKUL SEKOLAH</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <!-- Excel Export Library (SheetJS) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- QRCode Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Chart.js (Untuk Grafik) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; transition: background-color 0.3s; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: currentColor; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Media Print untuk Cetak Kartu QR */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area {
                position: fixed;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                display: flex !important;
                justify-content: center;
                align-items: center;
                background: white;
                z-index: 9999;
            }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // =================================================================================
        // IKON SVG (Pengganti Lucide untuk menghindari removeChild error)
        // =================================================================================
        const Icon = ({ name, size = 18, className = "" }) => {
            const icons = {
                dashboard: (
                    <>
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9 22 9 12 15 12 15 22"/>
                    </>
                ),
                users: (
                    <>
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </>
                ),
                check: <polyline points="20 6 9 17 4 12"/>,
                qr: (
                    <>
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </>
                ),
                report: (
                    <>
                        <line x1="18" y1="20" x2="18" y2="10"/>
                        <line x1="12" y1="20" x2="12" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="14"/>
                    </>
                ),
                settings: (
                    <>
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </>
                ),
                logout: (
                    <>
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </>
                ),
                camera: (
                    <>
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                        <circle cx="12" cy="13" r="4"/>
                    </>
                ),
                printer: (
                    <>
                        <polyline points="6 9 6 2 18 2 18 9"/>
                        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                        <rect x="6" y="14" width="12" height="8"/>
                    </>
                ),
                trash: (
                    <>
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        <line x1="10" y1="11" x2="10" y2="17"/>
                        <line x1="14" y1="11" x2="14" y2="17"/>
                    </>
                ),
                edit: (
                    <>
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </>
                )
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || null}
                </svg>
            );
        };

        // =================================================================================
        // KONFIGURASI API
        // =================================================================================
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw6TnTsmpoWeVonhXX_JPpYFTFPJA-fHNWFgoLH-UXbPI-Xl9oHiXznVf312w3aoi4D3Q/exec"; 

        const THEMES = {
            emerald: { bg: 'bg-emerald-50', text: 'text-emerald-800', primary: 'bg-emerald-600', hover: 'hover:bg-emerald-700', border: 'border-emerald-500', shadow: 'shadow-emerald-200', gradient: 'from-emerald-600 to-green-500' },
            blue: { bg: 'bg-blue-50', text: 'text-blue-800', primary: 'bg-blue-600', hover: 'hover:bg-blue-700', border: 'border-blue-500', shadow: 'shadow-blue-200', gradient: 'from-blue-600 to-indigo-500' },
            indigo: { bg: 'bg-indigo-50', text: 'text-indigo-800', primary: 'bg-indigo-600', hover: 'hover:bg-indigo-700', border: 'border-indigo-500', shadow: 'shadow-indigo-200', gradient: 'from-indigo-600 to-purple-500' },
            rose: { bg: 'bg-rose-50', text: 'text-rose-800', primary: 'bg-rose-600', hover: 'hover:bg-rose-700', border: 'border-rose-500', shadow: 'shadow-rose-200', gradient: 'from-rose-600 to-pink-500' },
            amber: { bg: 'bg-amber-50', text: 'text-amber-800', primary: 'bg-amber-600', hover: 'hover:bg-amber-700', border: 'border-amber-500', shadow: 'shadow-amber-200', gradient: 'from-amber-600 to-orange-500' },
        };

        const generateId = () => Math.random().toString(36).substr(2, 9);
        const getCurrentDate = () => new Date().toISOString().split('T')[0];

        const api = {
            async request(action, payload = {}) {
                if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.includes("ISI_URL")) return null; 
                try {
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: "POST",
                        body: JSON.stringify({ action, ...payload })
                    });
                    const result = await response.json();
                    if (result.status === 'success') return result.data;
                    throw new Error(result.message);
                } catch (error) {
                    console.error("API Error:", error);
                    return null;
                }
            }
        };

        // =================================================================================
        // SUB-COMPONENTS
        // =================================================================================

        const Login = ({ users, settings, onLogin }) => {
            const [form, setForm] = useState({ user: '', pass: '' });
            const [error, setError] = useState(false);
            const theme = THEMES[settings.themeColor || 'emerald'];

            const handleSubmit = (e) => {
                e.preventDefault();
                const found = users.find(u => u.username === form.user && u.password === form.pass);
                if (found) onLogin(found);
                else setError(true);
            };

            return (
                <div className={`min-h-screen flex items-center justify-center relative overflow-hidden ${theme.bg}`}>
                    <div className="absolute inset-0 z-0 bg-cover bg-center" style={{ backgroundImage: `url(${settings.loginBg || 'https://images.unsplash.com/photo-1508098682722-e99c43a406b2?q=80&w=2000'})`, filter: 'sepia(0.2) contrast(1.1) brightness(0.5)' }}></div>
                    <div className="relative z-10 bg-white rounded-2xl shadow-2xl w-full max-w-4xl overflow-hidden flex flex-col md:flex-row m-4 animate-fade-in">
                        {/* Area Visual Login (Sisi Kiri) - SEKARANG FULL COVER */}
                        <div 
                            className="md:w-1/2 h-48 md:h-auto bg-cover bg-center flex flex-col items-center justify-center p-8 relative overflow-hidden"
                            style={{ 
                                backgroundImage: `url(${settings.loginCardImage || 'https://images.unsplash.com/photo-1517927033932-b3d18e61fb3a?q=80&w=1000'})`,
                                backgroundSize: 'cover',
                                backgroundPosition: 'center'
                            }}
                        >
                            {/* Overlay Gradasi agar teks tetap terbaca */}
                            <div className={`absolute inset-0 z-0 bg-gradient-to-t ${theme.gradient} opacity-40`}></div>
                            
                            <div className="text-white text-center relative z-10">
                                <h2 className="text-3xl font-bold mb-2 drop-shadow-xl">{settings.appName || 'ABSEN DIGITAL ESKUL SEKOLAH'}</h2>
                                <p className="text-white/90 text-sm italic drop-shadow-lg font-medium">Platform Absensi Digital Modern.</p>
                            </div>
                        </div>

                        {/* Area Form Login (Sisi Kanan) */}
                        <div className="md:w-1/2 p-8 md:p-12 bg-white flex flex-col justify-center">
                             <h1 className="text-2xl font-bold text-gray-800 mb-6">Login Panel</h1>
                             <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase">Username</label>
                                    <input type="text" value={form.user} onChange={e => setForm({...form, user: e.target.value})} className="w-full border rounded-lg px-4 py-2 mt-1 focus:ring-2 outline-none border-gray-200" required />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase">Password</label>
                                    <input type="password" value={form.pass} onChange={e => setForm({...form, pass: e.target.value})} className="w-full border rounded-lg px-4 py-2 mt-1 focus:ring-2 outline-none border-gray-200" required />
                                </div>
                                {error && <div className="text-red-500 text-xs font-bold italic">Kredensial tidak valid!</div>}
                                <button className={`w-full ${theme.primary} ${theme.hover} text-white font-bold py-3 rounded-lg transition shadow-lg`}>Masuk Aplikasi</button>
                             </form>
                             <p className="mt-12 text-center text-[10px] text-gray-400 uppercase tracking-widest italic">Digital Presence System</p>
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ students, attendanceLog, settings, theme }) => {
            const today = getCurrentDate();
            const presentToday = attendanceLog.filter(a => a.date === today && a.status === 'Hadir').length;
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            const stats = useMemo(() => {
                const map = {};
                attendanceLog.forEach(log => {
                    const student = students.find(s => s.id === log.studentId);
                    const className = student?.class || 'N/A';
                    if(!map[className]) map[className] = { className, hadir:0, sakit:0, alfa:0, total:0 };
                    map[className].total++;
                    if(log.status === 'Hadir') map[className].hadir++;
                    else if(log.status === 'Sakit' || log.status === 'Izin') map[className].sakit++;
                    else map[className].alfa++;
                });
                return Object.values(map).sort((a,b) => a.className.localeCompare(b.className));
            }, [students, attendanceLog]);

            useEffect(() => {
                if (canvasRef.current && stats.length > 0) {
                    if (chartRef.current) chartRef.current.destroy();
                    const ctx = canvasRef.current.getContext('2d');
                    chartRef.current = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: stats.map(s => s.className),
                            datasets: [
                                { label: 'Hadir', data: stats.map(s => s.hadir), backgroundColor: '#10b981', borderRadius: 4 },
                                { label: 'Izin', data: stats.map(s => s.sakit), backgroundColor: '#f59e0b', borderRadius: 4 },
                                { label: 'Alfa', data: stats.map(s => s.alfa), backgroundColor: '#ef4444', borderRadius: 4 }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                    });
                }
            }, [stats]);

            return (
                <div className="space-y-6 animate-fade-in">
                    <h2 className={`text-2xl font-bold ${theme.text}`}>Dashboard Ringkasan</h2>
                    <div className={`bg-gradient-to-r ${theme.gradient} rounded-2xl p-6 text-white shadow-xl flex items-center justify-between relative overflow-hidden`}>
                        <div className="z-10">
                            <h3 className="text-2xl font-bold">Halo, Coach!</h3>
                            <p className="opacity-90 mt-1">Sistem siap merekam kehadiran hari ini.</p>
                        </div>
                        <img src={settings.logoUrl || 'https://via.placeholder.com/100'} className="w-20 h-20 object-contain rounded-full bg-white/20 p-2 z-10" />
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div className={`bg-white p-6 rounded-xl shadow border-l-4 ${theme.border}`}>
                            <div className="text-gray-500 text-sm">Anggota/Pemain</div>
                            <div className="text-3xl font-bold text-gray-800">{students.length}</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow border-l-4 border-blue-500">
                            <div className="text-gray-500 text-sm">Hadir Hari Ini</div>
                            <div className="text-3xl font-bold text-gray-800">{presentToday}</div>
                        </div>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-md">
                        <h3 className="font-semibold text-gray-700 mb-4 flex items-center gap-2">Grafik Statistik</h3>
                        <div className="relative h-64 w-full"><canvas ref={canvasRef}></canvas></div>
                    </div>
                </div>
            );
        };

        const StudentManager = ({ students, onAdd, onDelete, theme, settings }) => {
            const [form, setForm] = useState({ id: null, name: '', class: '', position: 'Pemain', gender: 'Laki-laki' });
            const [isEdit, setIsEdit] = useState(false);
            const [showQR, setShowQR] = useState(null);
            const qrRef = useRef(null);

            useEffect(() => {
                if (showQR && qrRef.current) {
                    qrRef.current.innerHTML = "";
                    new QRCode(qrRef.current, { text: showQR, width: 150, height: 150 });
                }
            }, [showQR]);

            const handleSubmit = (e) => {
                e.preventDefault();
                onAdd(form, isEdit);
                resetForm();
            };

            const resetForm = () => {
                setForm({ id: null, name: '', class: '', position: 'Pemain', gender: 'Laki-laki' });
                setIsEdit(false);
            };

            const startEdit = (s) => {
                setForm({ ...s });
                setIsEdit(true);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const selectedStudent = students.find(s => s.id === showQR);

            return (
                <div className="space-y-6 animate-fade-in">
                    <h2 className={`text-2xl font-bold ${theme.text}`}>Manajemen Anggota</h2>
                    
                    <form onSubmit={handleSubmit} className={`bg-white p-6 rounded-xl shadow-md border-t-4 ${theme.border}`}>
                        <h3 className="font-bold text-gray-700 mb-4">{isEdit ? 'Edit Data Anggota' : 'Tambah Anggota Baru'}</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="text-[10px] font-bold text-gray-400 uppercase ml-1">Nama Lengkap</label>
                                <input value={form.name} onChange={e => setForm({...form, name: e.target.value})} placeholder="Nama Lengkap" className="w-full border p-2 rounded focus:ring-2 outline-none mt-1" required />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-gray-400 uppercase ml-1">Kelas</label>
                                <input value={form.class} onChange={e => setForm({...form, class: e.target.value})} placeholder="Contoh: Kelas V" className="w-full border p-2 rounded focus:ring-2 outline-none mt-1" required />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-gray-400 uppercase ml-1">Jenis Kelamin</label>
                                <select value={form.gender} onChange={e => setForm({...form, gender: e.target.value})} className="w-full border p-2 rounded mt-1">
                                    <option>Laki-laki</option><option>Perempuan</option>
                                </select>
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-gray-400 uppercase ml-1">Posisi / Kategori</label>
                                <select value={form.position} onChange={e => setForm({...form, position: e.target.value})} className="w-full border p-2 rounded mt-1">
                                    <option>Pemain</option><option>Kiper</option><option>Bek</option><option>Gelandang</option><option>Penyerang</option>
                                </select>
                            </div>
                        </div>
                        <div className="flex gap-2 mt-6">
                            <button type="submit" className={`flex-1 ${theme.primary} text-white py-2 rounded font-bold shadow transition`}>{isEdit ? 'Simpan Perubahan' : 'Tambah Anggota'}</button>
                            {isEdit && <button type="button" onClick={resetForm} className="px-6 bg-gray-200 text-gray-600 rounded font-bold">Batal</button>}
                        </div>
                    </form>

                    <div className="bg-white rounded-xl shadow-md overflow-hidden">
                        <table className="w-full text-left">
                            <thead className="bg-gray-50 border-b">
                                <tr>
                                    <th className="p-4 text-xs font-bold text-gray-500 uppercase">Informasi Anggota</th>
                                    <th className="p-4 text-xs font-bold text-gray-500 uppercase text-right">Aksi</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {students.map(s => (
                                    <tr key={s.id} className="hover:bg-gray-50 transition">
                                        <td className="p-4">
                                            <div className="font-bold text-gray-800">{s.name}</div>
                                            <div className="text-[10px] text-gray-400 space-x-2">
                                                <span className="font-bold text-emerald-600">{s.class}</span>
                                                <span>•</span>
                                                <span>{s.gender}</span>
                                                <span>•</span>
                                                <span className="bg-gray-100 px-1 rounded">{s.position}</span>
                                            </div>
                                        </td>
                                        <td className="p-4 text-right space-x-3">
                                            <button onClick={() => setShowQR(s.id)} title="QR Code" className="p-1 text-blue-500 hover:scale-110 transition"><Icon name="qr"/></button>
                                            <button onClick={() => startEdit(s)} title="Edit" className="p-1 text-amber-500 hover:scale-110 transition"><Icon name="edit"/></button>
                                            <button onClick={() => onDelete(s.id)} title="Hapus" className="p-1 text-red-500 hover:scale-110 transition"><Icon name="trash"/></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {showQR && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onClick={() => setShowQR(null)}>
                            <div className="bg-white p-6 rounded-2xl text-center shadow-2xl animate-fade-in w-full max-w-xs" onClick={e => e.stopPropagation()}>
                                <div id="print-area" className="p-4 bg-white border-2 border-gray-100 rounded-xl flex flex-col items-center">
                                    <h4 className="font-bold text-lg text-emerald-800">{settings.appName}</h4>
                                    <p className="text-[10px] text-gray-400 mb-4 uppercase tracking-widest text-center">Kartu Anggota Digital</p>
                                    <div className="bg-white p-2 border-2 border-dashed rounded-lg mb-4" ref={qrRef}></div>
                                    <div className="text-center">
                                        <div className="font-bold text-gray-800 uppercase">{selectedStudent?.name}</div>
                                        <div className="text-xs text-gray-500">{selectedStudent?.class} • {selectedStudent?.position}</div>
                                    </div>
                                </div>
                                <div className="mt-6 flex gap-2 no-print">
                                    <button onClick={() => window.print()} className={`${theme.primary} text-white px-4 py-2 rounded-lg font-bold flex-1 flex items-center justify-center gap-2`}><Icon name="printer" size={14}/> Cetak</button>
                                    <button onClick={() => setShowQR(null)} className="bg-gray-100 text-gray-600 px-4 py-2 rounded-lg font-bold flex-1">Tutup</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ManualAttendance = ({ students, onSubmit, theme }) => {
            const [date, setDate] = useState(getCurrentDate());
            const [temp, setTemp] = useState({});
            const save = () => {
                const logs = Object.entries(temp).map(([studentId, status]) => ({ studentId, status, date }));
                if (logs.length > 0) {
                    onSubmit(logs);
                    setTemp({});
                    alert("Absensi berhasil disimpan ke database!");
                }
            };
            return (
                <div className="space-y-4 animate-fade-in">
                    <h2 className={`text-2xl font-bold ${theme.text}`}>Input Absensi</h2>
                    <div className="bg-white p-6 rounded-xl shadow-md">
                        <input type="date" value={date} onChange={e => setDate(e.target.value)} className="w-full border p-2 rounded mb-6 outline-none bg-gray-50" />
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <tbody className="divide-y">
                                    {students.map(s => (
                                        <tr key={s.id}>
                                            <td className="py-4">
                                                <div className="font-bold text-gray-800">{s.name}</div>
                                                <div className="text-[10px] text-gray-400">{s.class}</div>
                                            </td>
                                            <td className="py-4 text-right">
                                                <div className="flex gap-1 justify-end">
                                                    {['Hadir', 'Izin', 'Alfa'].map(st => (
                                                        <button key={st} onClick={() => setTemp({...temp, [s.id]: st})} className={`px-3 py-1.5 rounded text-[10px] font-bold transition ${temp[s.id] === st ? `${theme.primary} text-white` : 'bg-gray-100 text-gray-400'}`}>{st}</button>
                                                    ))}
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        <button onClick={save} className={`w-full mt-8 ${theme.primary} text-white py-4 rounded-xl font-bold shadow-lg transition transform active:scale-95`}>Kirim Data Absensi</button>
                    </div>
                </div>
            );
        };

        const Scanner = ({ students, onScanSuccess, theme }) => {
            const [isScanning, setIsScanning] = useState(false);
            const [result, setResult] = useState(null);
            const [cameraStatus, setCameraStatus] = useState('idle');

            useEffect(() => {
                let scanner;
                if (isScanning) {
                    setCameraStatus('asking');
                    scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: { width: 250, height: 250 } }, false);
                    
                    scanner.render((text) => {
                        const s = students.find(st => st.id === text);
                        if (s) {
                            setResult({ type: 'success', msg: `✅ ${s.name} Hadir!` });
                            onScanSuccess(s.id);
                            setTimeout(() => setResult(null), 2000);
                        } else setResult({ type: 'error', msg: '❌ QR Tidak Terdaftar' });
                    }, (err) => {});

                    const checkActive = setInterval(() => {
                        if (document.querySelector('#reader video')) {
                            setCameraStatus('active');
                            clearInterval(checkActive);
                        }
                    }, 500);

                    return () => {
                        clearInterval(checkActive);
                        if (scanner) scanner.clear().catch(e => console.error(e));
                    };
                }
            }, [isScanning, students]);

            return (
                <div className="space-y-4 animate-fade-in">
                    <h2 className={`text-2xl font-bold ${theme.text}`}>Scan QR Code</h2>
                    <div className="bg-white p-6 rounded-xl shadow-md text-center">
                        {!isScanning ? (
                            <div className="py-12">
                                <div className="mb-4 flex justify-center"><Icon name="qr" size={64} className="text-gray-200"/></div>
                                <button onClick={() => setIsScanning(true)} className={`${theme.primary} text-white px-8 py-4 rounded-full font-bold shadow-xl flex items-center gap-2 mx-auto transition-transform active:scale-95`}>
                                    <Icon name="camera" size={18}/> Aktifkan Scanner
                                </button>
                                <p className="text-xs text-gray-400 mt-4 italic">Mohon berikan izin kamera saat diminta browser.</p>
                            </div>
                        ) : (
                            <div>
                                {cameraStatus === 'asking' && (
                                    <div className="flex flex-col items-center py-10 text-emerald-600">
                                        <div className="spinner mb-4"></div>
                                        <p className="font-bold text-sm">Menunggu Izin Kamera...</p>
                                    </div>
                                )}
                                <div id="reader" className="w-full rounded-xl overflow-hidden border"></div>
                                <button onClick={() => setIsScanning(false)} className="mt-6 text-red-500 font-bold flex items-center justify-center gap-2 mx-auto"><Icon name="camera" size={18}/> Tutup Scanner</button>
                            </div>
                        )}
                        {result && <div className={`mt-4 p-4 rounded-lg font-bold animate-fade-in ${result.type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>{result.msg}</div>}
                    </div>
                </div>
            );
        };

        const AdminSettings = ({ settings, users, onUpdateSettings, onManageUser, theme }) => {
            const [local, setLocal] = useState(settings);
            const [userForm, setUserForm] = useState({ id: null, username: '', password: '', role: 'Admin' });
            const [isEditUser, setIsEditUser] = useState(false);

            const handleUserSubmit = (e) => {
                e.preventDefault();
                onManageUser(isEditUser ? 'UPDATE' : 'ADD', userForm);
                setUserForm({ id: null, username: '', password: '', role: 'Admin' });
                setIsEditUser(false);
            };

            return (
                <div className="space-y-8 animate-fade-in pb-12">
                    <h2 className={`text-2xl font-bold ${theme.text}`}>Pengaturan Sistem</h2>
                    <div className="bg-white p-6 rounded-xl shadow-md border-t-4 border-gray-800">
                        <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2"><Icon name="settings" size={20}/> Branding & Visual</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label className="text-[10px] font-bold text-gray-400 uppercase">Nama Aplikasi</label><input value={local.appName} onChange={e => setLocal({...local, appName: e.target.value})} className="w-full border rounded p-2 mt-1" /></div>
                            <div>
                                <label className="text-[10px] font-bold text-gray-400 uppercase">Tema Warna</label>
                                <select value={local.themeColor} onChange={e => setLocal({...local, themeColor: e.target.value})} className="w-full border rounded p-2 mt-1">
                                    {Object.keys(THEMES).map(t => <option key={t} value={t}>{t.charAt(0).toUpperCase() + t.slice(1)}</option>)}
                                </select>
                            </div>
                            <div><label className="text-[10px] font-bold text-gray-400 uppercase">URL Logo Bulat (Side Nav)</label><input value={local.logoUrl} onChange={e => setLocal({...local, logoUrl: e.target.value})} className="w-full border rounded p-2 mt-1" placeholder="https://..." /></div>
                            <div><label className="text-[10px] font-bold text-gray-400 uppercase">URL Gambar Kartu Login (Kiri)</label><input value={local.loginCardImage} onChange={e => setLocal({...local, loginCardImage: e.target.value})} className="w-full border rounded p-2 mt-1" placeholder="https://..." /></div>
                            <div className="md:col-span-2"><label className="text-[10px] font-bold text-gray-400 uppercase">URL Background Halaman Login</label><input value={local.loginBg} onChange={e => setLocal({...local, loginBg: e.target.value})} className="w-full border rounded p-2 mt-1" placeholder="https://..." /></div>
                        </div>
                        <button onClick={() => onUpdateSettings(local)} className={`mt-6 ${theme.primary} text-white px-6 py-2 rounded-lg font-bold shadow-lg`}>Simpan</button>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-500">
                        <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2"><Icon name="users" size={20}/> Kelola Admin</h3>
                        <form onSubmit={handleUserSubmit} className="flex flex-col md:flex-row gap-2 mb-6 bg-gray-50 p-4 rounded-xl">
                            <input value={userForm.username} onChange={e => setUserForm({...userForm, username: e.target.value})} placeholder="User" className="border p-2 rounded flex-1 outline-none" required />
                            <input type="password" value={userForm.password} onChange={e => setUserForm({...userForm, password: e.target.value})} placeholder="Pass" className="border p-2 rounded flex-1 outline-none" required />
                            <button className={`${isEditUser ? 'bg-amber-600' : 'bg-blue-600'} text-white px-6 py-2 rounded font-bold`}>{isEditUser ? 'Update' : 'Tambah'}</button>
                            {isEditUser && <button type="button" onClick={() => { setIsEditUser(false); setUserForm({id:null, username:'', password:'', role:'Admin'}); }} className="px-4 py-2 bg-gray-200 rounded font-bold">Batal</button>}
                        </form>
                        <div className="overflow-x-auto">
                            <table className="w-full text-xs text-left">
                                <thead className="bg-gray-100"><tr><th className="p-2">User</th><th className="p-2 text-right">Aksi</th></tr></thead>
                                <tbody>
                                    {users.map(u => (
                                        <tr key={u.id} className="border-b">
                                            <td className="p-2 font-medium">{u.username}</td>
                                            <td className="p-2 text-right space-x-2">
                                                <button onClick={() => { setUserForm(u); setIsEditUser(true); }} className="text-amber-500">Edit</button>
                                                {u.username !== 'admin' && <button onClick={() => onManageUser('DELETE', {id: u.id})} className="text-red-500">Hapus</button>}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [user, setUser] = useState(null);
            const [view, setView] = useState('dashboard');
            const [data, setData] = useState({ 
                students: [], 
                logs: [], 
                users: [{username:'admin', password:'admin', id:'def', role:'Super Admin'}], 
                settings: {appName: 'ABSEN DIGITAL ESKUL SEKOLAH', logoUrl: '', loginBg: '', loginCardImage: '', themeColor: 'emerald'} 
            });
            const [loading, setLoading] = useState(true);
            const [isConnected, setIsConnected] = useState(false);

            useEffect(() => { load(); }, []);

            const theme = THEMES[data.settings.themeColor || 'emerald'];

            const load = async () => {
                setLoading(true);
                const res = await api.request('GET_DATA');
                if (res) {
                    setData(res);
                    setIsConnected(true);
                } else {
                    setIsConnected(false);
                }
                setLoading(false);
            };

            const handleAddOrUpdateStudent = async (studentForm, isEdit) => {
                setLoading(true);
                const payload = { ...studentForm, id: isEdit ? studentForm.id : generateId() };
                const action = isEdit ? 'UPDATE_STUDENT' : 'ADD_STUDENT';
                const success = await api.request(action, payload);
                if (success) {
                    await load();
                } else {
                    alert("Gagal menyimpan data ke database.");
                    setLoading(false);
                }
            };

            const handleDeleteStudent = async (id) => {
                if(!confirm("Hapus data pemain ini selamanya?")) return;
                setLoading(true);
                const success = await api.request('DELETE_STUDENT', { id });
                if(success) await load();
                else setLoading(false);
            };

            const handleAttendance = async (arr) => {
                setLoading(true);
                const success = await api.request('SAVE_ATTENDANCE', arr.map(l => ({ ...l, id: generateId(), timestamp: new Date().toISOString(), method: 'Manual' })));
                if(success) await load();
                else setLoading(false);
            };

            const handleScan = async (studentId) => {
                setLoading(true);
                const success = await api.request('SAVE_ATTENDANCE', [{ studentId, date: getCurrentDate(), status: 'Hadir', method: 'Scan', id: generateId(), timestamp: new Date().toISOString() }]);
                if(success) await load();
                else setLoading(false);
            };

            const handleUpdateSettings = async (payload) => {
                setLoading(true);
                const success = await api.request('UPDATE_SETTINGS', { payload });
                if(success) {
                    alert("Pengaturan visual berhasil diperbarui!");
                    await load();
                } else {
                    alert("Gagal memperbarui pengaturan.");
                    setLoading(false);
                }
            };

            const handleManageUser = async (subAction, payload) => {
                setLoading(true);
                const success = await api.request('MANAGE_USER', { subAction, ...payload });
                if(success) await load();
                else setLoading(false);
            };

            if (!isLoggedIn) return <Login users={data.users} settings={data.settings} onLogin={(u) => { setIsLoggedIn(true); setUser(u); }} />;

            return (
                <div className={`flex flex-col md:flex-row h-screen ${theme.bg} text-gray-800 transition-colors`}>
                    <nav className="bg-white md:w-64 flex-shrink-0 flex md:flex-col p-4 shadow-xl z-20 sticky top-0 md:relative border-r no-print">
                        <div className="flex items-center gap-3 mb-0 md:mb-10">
                            <img src={data.settings.logoUrl || 'https://via.placeholder.com/40'} className="w-10 h-10 object-contain rounded-lg border border-gray-100" />
                            <div className="hidden md:block overflow-hidden">
                                <h1 className="font-bold text-xs leading-tight uppercase tracking-tight truncate">{data.settings.appName}</h1>
                                <p className="text-[9px] text-gray-400 font-bold uppercase">{user?.username}</p>
                            </div>
                        </div>

                        <div className="flex md:flex-col gap-1 overflow-x-auto md:overflow-visible w-full no-scrollbar">
                            {[
                                { id: 'dashboard', icon: 'dashboard', label: 'Dashboard' },
                                { id: 'students', icon: 'users', label: 'Pemain/Anggota' },
                                { id: 'manual', icon: 'check', label: 'Absen' },
                                { id: 'scan', icon: 'qr', label: 'Scan' },
                                { id: 'reports', icon: 'report', label: 'Laporan' },
                                { id: 'settings', icon: 'settings', label: 'Pengaturan' },
                            ].map(menu => (
                                <button key={menu.id} onClick={() => setView(menu.id)} className={`flex items-center gap-3 px-4 py-3 rounded-xl transition font-medium text-xs whitespace-nowrap ${view === menu.id ? `${theme.primary} text-white shadow-lg` : 'text-gray-500 hover:bg-gray-50'}`}>
                                    <Icon name={menu.icon} size={16}/>
                                    <span className="hidden md:inline">{menu.label}</span>
                                </button>
                            ))}
                        </div>

                        <div className="mt-auto hidden md:block pt-4 border-t">
                            <div className={`flex items-center gap-2 px-2 py-1.5 rounded-lg mb-2 ${isConnected ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
                                <div className={`w-2 h-2 rounded-full ${isConnected ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                                <span className="text-[10px] font-bold uppercase tracking-wider">{isConnected ? 'Terhubung' : 'Terputus'}</span>
                            </div>
                            <button onClick={() => setIsLoggedIn(false)} className="w-full flex items-center gap-2 text-red-500 text-xs px-4 py-3 hover:bg-red-50 rounded-xl transition font-bold"><Icon name="logout" size={16}/> Logout</button>
                            <div className="text-center mt-3 border-t pt-2 opacity-60">
                                <p className="text-[10px] text-gray-400 font-bold uppercase tracking-tighter">© 2026 Gurumasakini</p>
                                <a href="mailto:anomalicreator91@gmail.com" className="text-[9px] text-gray-300 lowercase block mt-0.5">anomalicreator91@gmail.com</a>
                            </div>
                        </div>
                    </nav>

                    <main className="flex-1 overflow-y-auto relative p-4 md:p-10 pb-20">
                        {loading && <div className="absolute inset-0 bg-white/60 z-50 flex items-center justify-center backdrop-blur-[1px]"><div className={`spinner ${theme.text}`}></div></div>}
                        <div className="max-w-4xl mx-auto">
                            {view === 'dashboard' && <Dashboard students={data.students} attendanceLog={data.logs} settings={data.settings} theme={theme} />}
                            {view === 'students' && <StudentManager students={data.students} onAdd={handleAddOrUpdateStudent} onDelete={handleDeleteStudent} theme={theme} settings={data.settings} />}
                            {view === 'manual' && <ManualAttendance students={data.students} onSubmit={handleAttendance} theme={theme} />}
                            {view === 'scan' && <Scanner students={data.students} onScanSuccess={handleScan} theme={theme} />}
                            {view === 'reports' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="flex justify-between items-center">
                                        <h2 className={`text-2xl font-bold ${theme.text}`}>Laporan</h2>
                                        <button onClick={() => {
                                            const csvData = data.logs.map(l => {
                                                const s = data.students.find(st => st.id === l.studentId);
                                                return { Tanggal: l.date, Nama: s?.name || '-', Kelas: s?.class || '-', Status: l.status };
                                            });
                                            const ws = XLSX.utils.json_to_sheet(csvData);
                                            const wb = XLSX.utils.book_new();
                                            XLSX.utils.book_append_sheet(wb, ws, "Log Absensi");
                                            XLSX.writeFile(wb, `Absensi_${new Date().toLocaleDateString()}.xlsx`);
                                        }} className="bg-green-700 text-white px-4 py-2 rounded text-sm font-bold flex items-center gap-2 shadow hover:bg-green-800 transition"><Icon name="report" size={14}/> Download Excel</button>
                                    </div>
                                    <div className="bg-white rounded-xl shadow overflow-hidden">
                                        <div className="overflow-x-auto max-h-[500px]">
                                            <table className="w-full text-sm text-left">
                                                <thead className="bg-gray-100 sticky top-0">
                                                    <tr><th className="p-3 text-xs font-bold text-gray-500 uppercase">Tanggal</th><th className="p-3 text-xs font-bold text-gray-500 uppercase">Nama Anggota</th><th className="p-3 text-xs font-bold text-gray-500 uppercase">Status</th></tr>
                                                </thead>
                                                <tbody className="divide-y">
                                                    {data.logs.slice().reverse().map((l, i) => {
                                                        const s = data.students.find(st => st.id === l.studentId);
                                                        return <tr key={i} className="hover:bg-gray-50 transition"><td className="p-3 text-gray-400 text-xs">{l.date}</td><td className="p-3 font-bold text-gray-700">{s?.name || 'Anggota Dihapus'}</td><td className="p-3"><span className={`px-2 py-0.5 rounded-full text-[10px] font-bold ${l.status === 'Hadir' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{l.status}</span></td></tr>
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            )}
                            {view === 'settings' && <AdminSettings settings={data.settings} users={data.users} onUpdateSettings={handleUpdateSettings} onManageUser={handleManageUser} theme={theme} />}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>